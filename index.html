<div id="view-lancamentos" class="view-content">
    <div class="balance-card">
        <span style="color: var(--text-gray)">SALDO ACUMULADO ATÉ <span id="label-mes-ano">---</span></span>
        <h2 id="saldo-periodo" style="font-size: 32px; margin: 10px 0;">R$ 0,00</h2>
    </div>

    <div class="stats-grid">
        <div class="stat-box up">
            <small style="color: var(--text-gray)">RECEITAS NO MÊS</small>
            <div id="resumo-receita" style="color: var(--success-green); font-weight: bold; font-size: 1.2em;">R$ 0,00</div>
        </div>
        <div class="stat-box down">
            <small style="color: var(--text-gray)">DESPESAS NO MÊS</small>
            <div id="resumo-despesa" style="color: var(--danger-red); font-weight: bold; font-size: 1.2em;">R$ 0,00</div>
        </div>
    </div>

    <div class="form-grid">
        <input type="text" id="desc" placeholder="Descrição">
        <input type="number" id="valor" placeholder="R$">
        <select id="tipo">
            <option value="receita">Receita</option>
            <option value="despesa">Despesa</option>
        </select>
        <button class="btn-add" onclick="adicionar()">Lançar</button>
    </div>
    
    <div style="margin-bottom: 20px; padding: 10px; border: 1px dashed var(--border); border-radius: 8px;">
        <small style="color: var(--warning-orange)">⚙️ CADASTRO FIXO (Repete todo mês)</small>
        <div class="form-grid" style="margin-top: 10px;">
            <input type="text" id="fixo-desc" placeholder="Ex: Aluguel">
            <input type="number" id="fixo-valor" placeholder="R$">
            <input type="number" id="fixo-dia" placeholder="Dia" min="1" max="31">
            <button class="btn-warning" onclick="adicionarFixo()">+ Fixo</button>
        </div>
    </div>

    <div id="feed-atividades"></div>
</div>

<script>
    // Novos bancos de dados no localStorage
    let db = JSON.parse(localStorage.getItem('financas_weverson')) || [];
    let db_fixos = JSON.parse(localStorage.getItem('fixos_weverson')) || [];

    function adicionarFixo() {
        const desc = document.getElementById('fixo-desc').value;
        const valor = parseFloat(document.getElementById('fixo-valor').value);
        const dia = document.getElementById('fixo-dia').value;
        const tipo = valor > 0 ? 'receita' : 'despesa'; // Defina pelo sinal ou mude o campo

        if (!desc || isNaN(valor) || !dia) return alert("Preencha os dados fixos");

        db_fixos.push({ desc, valor: Math.abs(valor), dia, tipo: document.getElementById('tipo').value });
        localStorage.setItem('fixos_weverson', JSON.stringify(db_fixos));
        alert("Transação fixa cadastrada!");
        renderizar();
    }

    function renderizar() {
        const mesAlvo = parseInt(document.getElementById('filtro-mes').value);
        const anoAlvo = parseInt(document.getElementById('filtro-ano').value);
        
        document.getElementById('label-mes-ano').innerText = `${mesAlvo}/${anoAlvo}`;

        let saldoAcumulado = 0;
        let receitasMes = 0;
        let despesasMes = 0;
        const feed = document.getElementById('feed-atividades');
        feed.innerHTML = "";

        // 1. Lógica de Acúmulo: Percorrer todos os meses desde o início até o mês selecionado
        // Para simplificar, vamos filtrar o banco total
        db.forEach(t => {
            const [d, m, a] = t.data.split('/').map(Number);
            const dataTransacao = new Date(a, m - 1, d);
            const dataFiltro = new Date(anoAlvo, mesAlvo - 1, 31);

            if (dataTransacao <= dataFiltro) {
                const v = t.tipo === 'receita' ? t.valor : -t.valor;
                saldoAcumulado += v;

                // Se for exatamente o mês que estamos vendo, alimenta o resumo
                if (m === mesAlvo && a === anoAlvo) {
                    t.tipo === 'receita' ? receitasMes += t.valor : despesasMes += t.valor;
                    feed.innerHTML += criarLinhaFeed(t);
                }
            }
        });

        // 2. Processar Transações Fixas para o mês atual
        db_fixos.forEach(f => {
            const v = f.tipo === 'receita' ? f.valor : -f.valor;
            
            // Adiciona ao saldo acumulado (Simulação de que ela ocorreu)
            saldoAcumulado += v; 
            
            // Adiciona ao resumo do mês visualizado
            f.tipo === 'receita' ? receitasMes += f.valor : despesasMes += f.valor;
            feed.innerHTML += `<div class="history-item" style="border-left: 3px solid var(--warning-orange); padding-left: 10px;">
                <div>[FIXO] ${f.desc}<br><small>Todo dia ${f.dia}</small></div>
                <div style="color:${f.tipo === 'receita' ? 'var(--success-green)' : 'var(--danger-red)'}">R$ ${f.valor.toFixed(2)}</div>
            </div>`;
        });

        // Atualiza Tela
        document.getElementById('saldo-periodo').innerText = `R$ ${saldoAcumulado.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
        document.getElementById('resumo-receita').innerText = `R$ ${receitasMes.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
        document.getElementById('resumo-despesa').innerText = `R$ ${despesasMes.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
    }

    function criarLinhaFeed(t) {
        return `<div class="history-item">
            <div>${t.desc}<br><small>${t.data}</small></div>
            <div style="color:${t.tipo === 'receita' ? 'var(--success-green)' : 'var(--danger-red)'}">R$ ${t.valor.toLocaleString('pt-BR', {minimumFractionDigits:2})}</div>
        </div>`;
    }
</script>
